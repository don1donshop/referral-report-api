<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¨è–¦äººè¨‚å–®æŸ¥è©¢</title>
</head>
<body>
  <h2>ğŸ“‹ æ¨è–¦äººè¨‚å–®æŸ¥è©¢</h2>
  <form id="orderForm">
    <label>æ¨è–¦ç¢¼ï¼š<input type="text" id="referral_code" required></label><br/>
    <label>Access Tokenï¼š<input type="text" id="access_token" required></label><br/>
    <label>èµ·å§‹æ™‚é–“ï¼š<input type="date" id="start_date"></label>
    <label>çµæŸæ™‚é–“ï¼š<input type="date" id="end_date"></label><br/><br/>
    <button type="submit">æŸ¥è©¢è¨‚å–®</button>
  </form>

  <p id="loading" style="display:none;">ğŸ“¡ æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</p>
  <p id="summary"></p>
  <button id="exportBtn" style="display:none;">ğŸ“¤ åŒ¯å‡ºå ±è¡¨ (CSV)</button>

  <table id="resultTable" border="1">
    <thead>
      <tr>
        <th>è¨‚å–®ç·¨è™Ÿ</th>
        <th>æˆç«‹æ™‚é–“</th>
        <th>é‡‘é¡</th>
        <th>ä»˜æ¬¾ç‹€æ…‹</th>
        <th>å‡ºè²¨ç‹€æ…‹</th>
        <th>ç‹€æ…‹</th>
        <th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiURL = "https://referral-report-api.onrender.com/orders";

    // å¦‚æœç¶²å€æœ‰å¸¶åƒæ•¸ï¼Œè‡ªå‹•å¡«å…¥è¡¨å–®
    window.addEventListener("load", () => {
      const params = new URLSearchParams(window.location.search);
      document.getElementById("referral_code").value = params.get("referral_code") || "";
      document.getElementById("access_token").value = params.get("access_token") || "";
    });

    document.getElementById("orderForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const code = document.getElementById("referral_code").value.trim();
      const token = document.getElementById("access_token").value.trim();
      const start = document.getElementById("start_date").value;
      const end = document.getElementById("end_date").value;

      const loading = document.getElementById("loading");
      const summary = document.getElementById("summary");
      const tbody = document.querySelector("#resultTable tbody");
      const exportBtn = document.getElementById("exportBtn");
      loading.style.display = "block";
      summary.textContent = "";
      tbody.innerHTML = "";
      exportBtn.style.display = "none";

      try {
        const url = new URL(apiURL);
        url.searchParams.set("referral_code", code);
        url.searchParams.set("access_token", token);
        if (start) url.searchParams.set("created_at_min", start + " 00:00:00");
        if (end) url.searchParams.set("created_at_max", end + " 23:59:59");

        const res = await fetch(url);
        const data = await res.json();

        loading.style.display = "none";

        if (!res.ok || data.error) {
          summary.textContent = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${data.error || "æœªçŸ¥éŒ¯èª¤"}`;
          return;
        }

        if (data.message) {
          summary.textContent = "æŸ¥ç„¡è¨‚å–®";
          return;
        }

        let total = 0;
        data.forEach(order => {
          const row = tbody.insertRow();
          row.insertCell().innerText = order.order_number;
          row.insertCell().innerText = order.created_at;
          row.insertCell().innerText = order.total_price;
          row.insertCell().innerText = order.financial_status;
          row.insertCell().innerText = order.fulfillment_status;
          row.insertCell().innerText = order.is_cancelled ? "âŒ å·²å–æ¶ˆ" : "âœ… æœ‰æ•ˆ";
          row.insertCell().innerText = order.remark || "";
          total += parseFloat(order.total_price);
        });

        summary.textContent = `âœ… å…± ${data.length} ç­†è¨‚å–®ï¼Œç¸½é‡‘é¡ï¼šNT$ ${total.toFixed(0)} å…ƒ`;
        exportBtn.style.display = "inline-block";

        exportBtn.onclick = () => {
          const csv = "è¨‚å–®ç·¨è™Ÿ,æˆç«‹æ™‚é–“,é‡‘é¡,ä»˜æ¬¾ç‹€æ…‹,å‡ºè²¨ç‹€æ…‹,ç‹€æ…‹,å‚™è¨»\n" + data.map(o =>
            [o.order_number, o.created_at, o.total_price, o.financial_status, o.fulfillment_status, o.is_cancelled ? "å·²å–æ¶ˆ" : "æœ‰æ•ˆ", o.remark || ""].join(",")
          ).join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `orders_${code}.csv`;
          link.click();
        };
      } catch (err) {
        loading.style.display = "none";
        summary.textContent = `âŒ æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å•Ÿå‹•æˆ–ç¶²è·¯æ˜¯å¦é€šé †`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
