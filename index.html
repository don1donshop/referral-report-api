<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>📋 推薦人訂單查詢</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, select {
      padding: 5px;
      width: 250px;
    }
    button {
      margin-top: 1em;
      padding: 8px 20px;
      font-size: 16px;
    }
    #token_section {
      display: none;
    }
  </style>
</head>
<body>
  <h2>📋 推薦人訂單查詢</h2>

  <label for="referral_code">推薦碼：</label>
  <select id="referral_code" onchange="onReferralChange()">
    <option value="">請選擇推薦碼</option>
    <option value="LAVONS88">LAVONS88</option>
    <option value="LAVONS_WINNIE">LAVONS_WINNIE</option>
    <option value="LAVONS_XIAOSHAN">LAVONS_XIAOSHAN</option>
  </select>

  <div id="token_section">
    <label for="access_token">Access Token：</label>
    <input type="password" id="access_token" />
  </div>

  <label for="start_time">起始時間：</label>
  <input type="datetime-local" id="start_time" />

  <label for="end_time">結束時間：</label>
  <input type="datetime-local" id="end_time" />

  <button id="query_btn" onclick="fetchOrders()" disabled>查詢訂單</button>

  <pre id="result"></pre>

  <script>
    function onReferralChange() {
      const code = document.getElementById("referral_code").value;
      const tokenSection = document.getElementById("token_section");
      const tokenInput = document.getElementById("access_token");
      tokenSection.style.display = code ? "block" : "none";
      tokenInput.value = "";
      updateButtonState();
    }

    function updateButtonState() {
      const code = document.getElementById("referral_code").value;
      const token = document.getElementById("access_token").value;
      const btn = document.getElementById("query_btn");
      btn.disabled = !(code && token);
    }

    document.getElementById("access_token").addEventListener("input", updateButtonState);

    function fetchOrders() {
      const referral = document.getElementById("referral_code").value;
      const token = document.getElementById("access_token").value;
      const start = document.getElementById("start_time").value.replace("T", " ");
      const end = document.getElementById("end_time").value.replace("T", " ");

      const url = `https://referral-report-api.onrender.com/orders?referral_code=${referral}&access_token=${token}&created_at_min=${start}&created_at_max=${end}`;
      const resultBox = document.getElementById("result");
      resultBox.textContent = "⏳ 查詢中...";

      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          resultBox.textContent = JSON.stringify(data, null, 2);
        })
        .catch((err) => {
          resultBox.textContent = "❌ 發生錯誤：" + err.message;
        });
    }

    // 預設填入今天 00:00 ~ 現在時間（整點/半點）
    window.onload = () => {
      const now = new Date();
      now.setMinutes(now.getMinutes() < 30 ? 0 : 30, 0, 0);
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const fmt = (d) => d.toISOString().slice(0, 16);
      document.getElementById("start_time").value = fmt(today);
      document.getElementById("end_time").value = fmt(now);
    };
  </script>
</body>
</html>
